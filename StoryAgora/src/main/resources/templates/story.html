<!DOCTYPE html>
<html xmlns:th="http://thymeleaf.org">
<head>
<meta charset="ISO-8859-1">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta id="_csrf" name="_csrf" th:content="${_csrf.token}" />
<meta id="_csrf_header" name="_csrf_header"
   th:content="${_csrf.headerName}" />
<title>Stories</title>
<script th:replace="fragments/imports :: imports"></script>
<script type="text/javascript">
	$(function() {
		$("#editStoryBtn").click(function() {
			var id = $("#storyID").val();
			var address = "/story/" + id + "/editStory";
			window.location.href = address;
		});
	});

	$(function() {
		$('#deleteStoryBtn').click(function(e) {
			e.preventDefault();
			var token = $('#_csrf').attr('content');
			var header = $('#_csrf_header').attr('content');
			var pathname = window.location.pathname;
			var redirectUrl = '/u/' + $("#username").val();

			$.ajax({
				url : pathname,
				type : 'DELETE',
				beforeSend : function(xhr) {
					xhr.setRequestHeader(header, token);
				},
				success : function() {
					console.log("story deleted successfully");
					window.location = redirectUrl;
				}
			})
		})
	});
</script>
</head>
<body>
   <div th:replace="fragments/navbar :: navbar"></div>
   <div class="container">
      <div class="row story-title">
         <input type="hidden" th:field="${story.id}" id="storyID">
         <input type="hidden" th:field="${user.username}" id="username">
         <div class="col-12">
            <h1 th:text="${story.title}"></h1>
         </div>
         <div class="col-12 author">
            <span>by: </span> <a th:text="${story.user.name}"
               th:href="@{/u/{username}(username=${story.user.username})}">
            </a>
         </div>
         <div class="story-date col-12">
            <span
               th:text="${#dates.format(story.createdDate, 'dd-MM-yyyy')}"></span>
         </div>
         <div class="col-12 content mt-4">
            <p th:utext="${story.content}"></p>
         </div>
         <div class="col float-right story-edit-btn">
            <div th:if="${story.user.username} == ${user.username}">
               <button id="editStoryBtn" class="btn btn-primary ml-auto">Edit
                  Story</button>
            </div>
         </div>
      </div>

      <div class="row" style="margin-top: 4em">
         <div class="col-12">
            <h2>Comments</h2>
         </div>
         <div class="col-12">
            <form
               th:action="@{/story/{storyID}/comments(storyID=${story.id})}"
               method="post">
               <input type="hidden" th:name="${_csrf.parameterName}"
                  th:value="${_csrf.token}" />
               <div class="form-group">
                  <label for="exampleFormControlTextarea1">Leave
                     a comment below</label>
                  <textarea required maxlength="500"
                     class="form-control" th:field="${newComment.text}"
                     rows="3"></textarea>
               </div>
               <button type="submit" class="btn btn-primary">Add
                  Comment</button>
            </form>
         </div>
         <div class="col-12">
            <div th:each="comment: *{commentSet}">
               <div class="comment">
                  <div class="comment-text">
                     <span th:text="${comment.text}"></span> 
                  </div>
                  <div class="comment-user text-right">
                     <a th:text="${comment.user.name}"
                        th:href="@{/u/{username}(username=${comment.user.username})}"></a>
                  </div>
               </div>
            </div>
         </div>

      </div>
      <div class="row">
         <div class="col-12">
            <div class="float-right"
               th:if="${story.user.username} == ${user.username}"
               style="margin-top: 4em;">
               <button type="button" class="btn btn-delete ml-auto"
                  data-toggle="modal" data-target="#confirmDeleteModal">Delete
                  Story</button>
            </div>
         </div>
      </div>
   </div>


   <!-- Modal Confirm Delete -->
   <div class="modal fade" id="confirmDeleteModal" tabindex="-1"
      role="dialog" aria-labelledby="confirmDeleteLabel"
      aria-hidden="true">
      <div class="modal-dialog" role="document">
         <div class="modal-content text-center">
            <div class="modal-header text-center">
               <h5 class="modal-title" id="confirmDeleteLabel">Confirmation</h5>
               <button type="button" class="close" data-dismiss="modal"
                  aria-label="Close">
                  <span aria-hidden="true">&times;</span>
               </button>
            </div>
            <div class="modal-body">
               <p>Are you sure?</p>
               <p>This action will permanently delete your story.</p>
            </div>
            <div class="modal-footer">
               <button type="button" class="btn btn-primary mr-auto"
                  data-dismiss="modal">Cancel</button>
               <form action="">
                  <button type="submit" class="btn btn-delete"
                     id="deleteStoryBtn">Yes</button>
               </form>
            </div>
         </div>
      </div>
   </div>
</body>
</html>